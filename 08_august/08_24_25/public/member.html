<!DOCTYPE html>
<html>
    <!-- quote page for a logged in user -->
    <head>
        <style>
            body {
                background-color: #FAF9F6;
                font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                margin: 0;
                padding: 0;
                display: flex;
                justify-content: center;
            }
            .container {
                width: 80%;
                max-width: 900px;
                margin: 0 auto;
            }
            .top {
                display: flex;
                align-items: center;
                justify-content: space-between;
                background-color: #333;
                color: #FAF9F6;
                padding: 0.5rem 1rem;
                border-radius: 12px;
                margin-top: 1rem;
            }
            .top button {
                background-color: #444;
                color: #FAF9F6;
                border: none;
                padding: 0.5rem 1rem;
                margin: 0 0.25rem;
                border-radius: 8px;
                cursor: pointer;
                font-size: 0.9rem;
            }
            .top button:hover {
                background-color: #555;
            }
            .leftarrow, .rightarrow {
                cursor: pointer;
                font-size: 1.2rem;
                padding: 0 0.5rem;
            }
            .header {
                text-align: center;
                padding: 1rem;
                font-size: 1.5rem;
                font-weight: bold;
                color: #FAF9F6;
                border-radius: 12px;
                margin-top: 1rem;
            }
            .header span {
                display: none;
            }
            .quote_section {
                margin: 1.5rem auto;
                background-color: #2e2e2e;
                padding: 1rem;
                border-radius: 12px;
                color: #FAF9F6;
                box-shadow: 0px 2px 6px rgba(0,0,0,0.15);
            }
            .quote-title {
                font-size: 1.2rem;
                font-weight: bold;
                margin-bottom: 0.5rem;
                text-align: center;
            }
            .user-quote {
                font-size: 0.9rem;
                margin-bottom: 1rem;
                display: block;
                text-align: center;
            }
            .quote {
                padding: 1rem;
                border-radius: 10px;
                background-color: rgba(255,255,255,0.05);
                text-align: center;
            }
            .quote-text {
                font-size: 1.1rem;
                margin-bottom: 0.5rem;
                max-width: 450px; 
                width: 100%;   
                text-align: center;
                margin: 0 auto;
            }
            .quote button {
                margin-top: 0.5rem;
                padding: 0.5rem 1rem;
                border: none;
                border-radius: 8px;
                font-weight: bold;
                cursor: pointer;
                color: #FAF9F6;
                margin-bottom: 1.5rem;
            }
            .quote-footer {
                margin-top: 1rem;
                font-size: 0.8rem;
                text-align: center;
                opacity: 0.8;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="top">
                <button class="leftarrow">&larr;</button>
                <button class="addnew">&plus; add new quote</button>
                <button class="returnhome">return to home</button>
                <button class="rightarrow">&rarr;</button>
            </div>
            <div class="header">
                <span class="latest-label">Latest Quote!</span>
                <span class="group-label">{group} Quotes</span>
            </div>
            <div class="quote_section">
                <div class="quote-title">Quote Title Here</div>
                <span class="user-quote">{date} shared by {username}</span>
                <div class="quote">
                    <div class="quote-text">{quote}</div>
                    <div>&mdash; {author}, {source}</div>
                    <button>MORE ABOUT {author}</button>
                </div>
                <div class="quote-footer">{group} Quote # {quote_id}</div>
            </div>
        </div>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
            import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
            import { getFirestore, doc, getDoc, collection, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

            const firebaseConfig = {
                apiKey: "AIzaSyBiPZ-0U1CZHbGzn8JS2cFCPMVK_5ftHyc",
                authDomain: "quote-app-a8c50.firebaseapp.com",
                projectId: "quote-app-a8c50",
                storageBucket: "quote-app-a8c50.firebasestorage.app",
                messagingSenderId: "1011977846276",
                appId: "1:1011977846276:web:d4a30ccef5556fe3713f51",
                measurementId: "G-2C7W5JCJDD"
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            let currentQuotes = [];
            let currentIndex = 0;
            let userColor = "#0077cc";
            let userName = "Unknown User";
            let groupName = "Group";
            let groupId = "group-placeholder";

            // ------------------------
            // Render a quote at index
            // ------------------------
            function renderQuoteAt(index) {
                if (currentQuotes.length === 0) return;
                const quote = currentQuotes[index];
                document.querySelector(".header").style.backgroundColor = userColor;
                document.querySelector(".quote-title").innerText = groupName;
                document.querySelector(".user-quote").innerText =
                    new Date(quote.timestamp.toDate()).toLocaleDateString() + " shared by " + userName;
                document.querySelector(".user-quote").style.color = userColor;
                document.querySelector(".quote-text").innerText = "\n \"" + quote.text + "\"\n\n";
                document.querySelector(".quote button").innerText = "More about " + quote.author;
                document.querySelector(".quote button").style.backgroundColor = userColor;
                document.querySelector(".quote div:nth-child(2)").innerText = `â€” ${quote.author}, ${quote.source}`;
                document.querySelector(".quote-footer").innerText = `- ${groupName} Quote #${index + 1} -`;
                document.querySelector(".latest-label").style.display = "inline";
            }

            // ------------------------
            // Load all quotes
            // ------------------------
            async function loadQuotes() {
                const q = query(collection(db, "groups", groupId, "quotes"), orderBy("timestamp", "asc"));
                const snap = await getDocs(q);
                currentQuotes = snap.docs.map(doc => doc.data());
                console.log("Loaded quotes:", currentQuotes);
                currentIndex = currentQuotes.length - 1;
                renderQuoteAt(currentIndex);
            }

            // ------------------------
            // Setup buttons safely
            // ------------------------
            document.addEventListener("DOMContentLoaded", () => {
                const leftArrow = document.querySelector(".leftarrow");
                const rightArrow = document.querySelector(".rightarrow");
                const addNew = document.querySelector(".addnew");
                const returnHome = document.querySelector(".returnhome");

                leftArrow.addEventListener("click", () => {
                    if (currentQuotes.length === 0) return;
                    currentIndex = (currentIndex - 1 + currentQuotes.length) % currentQuotes.length;
                    renderQuoteAt(currentIndex);
                });

                rightArrow.addEventListener("click", () => {
                    if (currentQuotes.length === 0) return;
                    currentIndex = (currentIndex + 1) % currentQuotes.length;
                    renderQuoteAt(currentIndex);
                });

                addNew.addEventListener("click", () => {
                    // addNewQuote(); // implement later
                    alert("Add new quote button clicked!");
                });

                returnHome.addEventListener("click", () => {
                    window.location.href = "index.html";
                });
            });

            // ------------------------
            // Initialize page after auth
            // ------------------------
            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    window.location.href = "index.html";
                    return;
                }

                const userUid = "tp987oF9EnnTsbNIxKdh";  // placeholder user
                const userSnap = await getDoc(doc(db, "users", userUid));
                if (userSnap.exists()) {
                    const userData = userSnap.data();
                    userColor = userData.color || "#0077cc";
                    userName = userData.name || "Unknown User";
                    if (userData.groups && userData.groups.length > 0) groupId = userData.groups[0];
                }

                const groupSnap = await getDoc(doc(db, "groups", groupId));
                if (groupSnap.exists()) {
                    groupName = groupSnap.data().name || "Group";
                }

                await loadQuotes();
            });
        </script>




    </body>
</html>
